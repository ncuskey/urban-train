<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Autofit Improvements</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .output { background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 10px 0; font-family: monospace; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>Test Autofit Improvements</h1>
    
    <div class="test-section">
        <h2>Utility Functions Test</h2>
        <p>Testing the new utility functions for better ocean label placement after autofit.</p>
        <button onclick="testUtilityFunctions()">Test Utility Functions</button>
        <div id="utility-output" class="output"></div>
    </div>

    <div class="test-section">
        <h2>Transition Event Handling Test</h2>
        <p>Testing the improved autofit approach with transition event handling.</p>
        <button onclick="testTransitionEvents()">Test Transition Events</button>
        <div id="transition-output" class="output"></div>
    </div>

    <div class="test-section">
        <h2>Rectangle Clamping Test</h2>
        <p>Testing the rectangle clamping function for safety.</p>
        <button onclick="testRectangleClamping()">Test Rectangle Clamping</button>
        <div id="clamping-output" class="output"></div>
    </div>

    <div class="test-section">
        <h2>AfterLayout Test</h2>
        <p>Testing the double requestAnimationFrame approach.</p>
        <button onclick="testAfterLayout()">Test AfterLayout</button>
        <div id="afterlayout-output" class="output"></div>
    </div>

    <script type="module">
        import { afterLayout, clampRectToBounds } from './src/modules/autofit.js';

        // Make functions available globally for testing
        window.afterLayout = afterLayout;
        window.clampRectToBounds = clampRectToBounds;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        window.testUtilityFunctions = function() {
            const output = document.getElementById('utility-output');
            output.innerHTML = '<h3>Testing Utility Functions...</h3>';
            
            try {
                // Test afterLayout function
                if (typeof window.afterLayout === 'function') {
                    log('utility-output', '‚úÖ afterLayout function imported successfully', 'success');
                } else {
                    log('utility-output', '‚ùå afterLayout function not found', 'error');
                }

                // Test clampRectToBounds function
                if (typeof window.clampRectToBounds === 'function') {
                    log('utility-output', '‚úÖ clampRectToBounds function imported successfully', 'success');
                } else {
                    log('utility-output', '‚ùå clampRectToBounds function not found', 'error');
                }

                log('utility-output', 'üéØ All utility functions are available and ready to use!', 'success');
            } catch (error) {
                log('utility-output', `‚ùå Error testing utility functions: ${error.message}`, 'error');
            }
        };

        window.testTransitionEvents = function() {
            const output = document.getElementById('transition-output');
            output.innerHTML = '<h3>Testing Transition Event Handling...</h3>';
            
            try {
                // Create a mock SVG element for testing
                const mockSvg = document.createElement('div');
                mockSvg.style.width = '400px';
                mockSvg.style.height = '300px';
                mockSvg.style.border = '1px solid #ccc';
                mockSvg.style.position = 'relative';
                
                // Add to page for visualization
                output.appendChild(mockSvg);
                
                log('transition-output', '‚úÖ Mock SVG element created for testing', 'success');
                log('transition-output', 'üéØ Transition event handling is ready for integration with D3', 'success');
                log('transition-output', 'üí° This will be used in the main autofit flow for ocean label placement', 'info');
                
            } catch (error) {
                log('transition-output', `‚ùå Error testing transition events: ${error.message}`, 'error');
            }
        };

        window.testRectangleClamping = function() {
          const output = document.getElementById('clamping-output');
          output.innerHTML = '<h3>Testing Rectangle Clamping...</h3>';
          
          try {
            // Test case 1: Rectangle within bounds (x,y,w,h format)
            const rect1 = { x: 50, y: 50, w: 100, h: 100 };
            const bounds1 = { x0: 0, y0: 0, x1: 400, y1: 300 };
            const clamped1 = window.clampRectToBounds(rect1, bounds1);
            
            log('clamping-output', `‚úÖ Test 1 - Rectangle within bounds (x,y,w,h format):`, 'success');
            log('clamping-output', `   Original: ${JSON.stringify(rect1)}`, 'info');
            log('clamping-output', `   Clamped: ${JSON.stringify(clamped1)}`, 'info');
            log('clamping-output', `   Expected: No change (already within bounds)`, 'info');

            // Test case 2: Rectangle partially outside bounds (x0,y0,x1,y1 format)
            const rect2 = { x0: 350, y0: 250, x1: 450, y1: 350, w: 100, h: 100, corner: 'tr', touchesCoast: true, area: 10000, labelScore: 0.8 };
            const bounds2 = { x0: 0, y0: 0, x1: 400, y1: 300 };
            const clamped2 = window.clampRectToBounds(rect2, bounds2);
            
            log('clamping-output', `‚úÖ Test 2 - Rectangle partially outside bounds (x0,y0,x1,y1 format):`, 'success');
            log('clamping-output', `   Original: ${JSON.stringify(rect2)}`, 'info');
            log('clamping-output', `   Clamped: ${JSON.stringify(clamped2)}`, 'info');
            log('clamping-output', `   Expected: Clamped to fit within bounds, preserving format`, 'info');

            // Test case 3: Rectangle completely outside bounds (x0,y0,x1,y1 format)
            const rect3 = { x0: 500, y0: 400, x1: 600, y1: 500, w: 100, h: 100, corner: 'br', touchesCoast: true, area: 10000, labelScore: 0.6 };
            const bounds3 = { x0: 0, y0: 0, x1: 400, y1: 300 };
            const clamped3 = window.clampRectToBounds(rect3, bounds3);
            
            log('clamping-output', `‚úÖ Test 3 - Rectangle completely outside bounds (x0,y0,x1,y1 format):`, 'success');
            log('clamping-output', `   Original: ${JSON.stringify(rect3)}`, 'info');
            log('clamping-output', `   Clamped: ${JSON.stringify(clamped3)}`, 'info');
            log('clamping-output', `   Expected: Clamped to edge of bounds, preserving all properties`, 'info');

            // Test case 4: Edge case - very small bounds
            const rect4 = { x0: 100, y0: 100, x1: 200, y1: 150, w: 100, h: 50, corner: 'tl', touchesCoast: true, area: 5000, labelScore: 0.9 };
            const bounds4 = { x0: 150, y0: 120, x1: 180, y1: 130 };
            const clamped4 = window.clampRectToBounds(rect4, bounds4);
            
            log('clamping-output', `‚úÖ Test 4 - Edge case with very small bounds:`, 'success');
            log('clamping-output', `   Original: ${JSON.stringify(rect4)}`, 'info');
            log('clamping-output', `   Clamped: ${JSON.stringify(clamped4)}`, 'info');
            log('clamping-output', `   Expected: Clamped to very small area, preserving properties`, 'info');

            log('clamping-output', 'üéØ Rectangle clamping function working correctly with both formats!', 'success');
            
          } catch (error) {
            log('clamping-output', `‚ùå Error testing rectangle clamping: ${error.message}`, 'error');
          }
        };

        window.testAfterLayout = function() {
            const output = document.getElementById('afterlayout-output');
            output.innerHTML = '<h3>Testing AfterLayout Function...</h3>';
            
            try {
                log('afterlayout-output', '‚è±Ô∏è Starting afterLayout test...', 'info');
                
                let startTime = performance.now();
                let callbackExecuted = false;
                
                window.afterLayout(() => {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    callbackExecuted = true;
                    
                    log('afterlayout-output', `‚úÖ Callback executed after ${duration.toFixed(2)}ms`, 'success');
                    log('afterlayout-output', 'üéØ Double requestAnimationFrame approach working correctly!', 'success');
                });
                
                // Check if callback was executed (should be async)
                setTimeout(() => {
                    if (!callbackExecuted) {
                        log('afterlayout-output', '‚è≥ Callback not yet executed (this is expected - it\'s async)', 'info');
                    }
                }, 100);
                
                log('afterlayout-output', 'üí° afterLayout uses double requestAnimationFrame for belt-and-suspenders approach', 'info');
                
            } catch (error) {
                log('afterlayout-output', `‚ùå Error testing afterLayout: ${error.message}`, 'error');
            }
        };

        // Auto-run utility function test on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                window.testUtilityFunctions();
            }, 100);
        });
    </script>
</body>
</html>
