<!DOCTYPE html>
<html>
<head>
    <title>Verify Viewport Culling</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
        
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 1000;
        }
        
        button {
            margin: 5px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <h1>Verify Viewport Culling</h1>
    
    <div id="controls">
        <h3>Controls</h3>
        <button onclick="testCulling()">Test Culling</button>
        <button onclick="checkOceanVisibility()">Check Ocean</button>
        <button onclick="logLabelCounts()">Count Labels</button>
        <button onclick="forceCullUpdate()">Force Cull Update</button>
        <div id="status"></div>
    </div>
    
    <div class="test-section">
        <h2>Instructions</h2>
        <ol>
            <li>Load the main application at <a href="../index.html" target="_blank">index.html</a></li>
            <li>Wait for the map to generate and labels to appear</li>
            <li>Zoom in until some labels scroll off screen</li>
            <li>Zoom back out and verify the ocean label returns</li>
            <li>Use the controls above to test the culling functions</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script type="module">
        import { updateViewportCull, ensureOceanStickyVisibility, currentTier, tierForZoom } from '../src/modules/labels.js';
        
        const results = [];
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            results.push({ message, type, time: new Date() });
            
            // Keep only last 20 results
            if (results.length > 20) {
                results.shift();
                document.getElementById('results').removeChild(document.getElementById('results').firstChild);
            }
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Test functions that can be called from the main app
        window.testCulling = function() {
            log('Testing viewport culling...', 'info');
            
            const svg = d3.select('svg');
            if (svg.empty()) {
                log('No SVG found - make sure main app is loaded', 'error');
                return;
            }
            
            try {
                updateViewportCull(svg.node());
                log('✓ Viewport culling executed successfully', 'success');
                
                const totalLabels = svg.selectAll('text.label').size();
                const visibleLabels = svg.selectAll('text.label:not(.culled)').size();
                const culledLabels = svg.selectAll('text.label.culled').size();
                
                log(`Labels: ${visibleLabels} visible, ${culledLabels} culled (${totalLabels} total)`, 'info');
                updateStatus(`Labels: ${visibleLabels}/${totalLabels} visible`);
                
            } catch (error) {
                log(`✗ Error in viewport culling: ${error.message}`, 'error');
            }
        };
        
        window.checkOceanVisibility = function() {
            log('Checking ocean label visibility...', 'info');
            
            const ocean = d3.select('text.label--ocean');
            if (ocean.empty()) {
                log('✗ No ocean label found', 'error');
                return;
            }
            
            const isCulled = ocean.classed('culled');
            const isHidden = ocean.classed('hidden');
            const display = ocean.style('display');
            const visibility = ocean.attr('visibility');
            const opacity = ocean.attr('opacity');
            
            log(`Ocean label state:`, 'info');
            log(`  - culled: ${isCulled}`, 'info');
            log(`  - hidden: ${isHidden}`, 'info');
            log(`  - display: ${display}`, 'info');
            log(`  - visibility: ${visibility}`, 'info');
            log(`  - opacity: ${opacity}`, 'info');
            log(`  - currentTier: ${currentTier.value}`, 'info');
            
            if (currentTier.value >= 1 && (isCulled || isHidden)) {
                log('✗ Ocean should be visible but is culled/hidden', 'error');
            } else {
                log('✓ Ocean visibility is correct', 'success');
            }
            
            // Try to force ocean visibility
            ensureOceanStickyVisibility();
            log('✓ ensureOceanStickyVisibility executed', 'success');
        };
        
        window.logLabelCounts = function() {
            const svg = d3.select('svg');
            if (svg.empty()) {
                log('No SVG found', 'error');
                return;
            }
            
            const allLabels = svg.selectAll('text.label');
            const oceanLabels = svg.selectAll('text.label--ocean');
            const lakeLabels = svg.selectAll('text.label').filter(d => d && d.kind === 'lake');
            const islandLabels = svg.selectAll('text.label').filter(d => d && d.kind === 'island');
            
            log(`Label counts:`, 'info');
            log(`  - Total: ${allLabels.size()}`, 'info');
            log(`  - Oceans: ${oceanLabels.size()}`, 'info');
            log(`  - Lakes: ${lakeLabels.size()}`, 'info');
            log(`  - Islands: ${islandLabels.size()}`, 'info');
            
            // Check tiers
            const tier1 = svg.selectAll('text.label').filter(d => d && d.tier === 1).size();
            const tier2 = svg.selectAll('text.label').filter(d => d && d.tier === 2).size();
            const tier3 = svg.selectAll('text.label').filter(d => d && d.tier === 3).size();
            const tier4 = svg.selectAll('text.label').filter(d => d && d.tier === 4).size();
            
            log(`Tier counts:`, 'info');
            log(`  - Tier 1: ${tier1}`, 'info');
            log(`  - Tier 2: ${tier2}`, 'info');
            log(`  - Tier 3: ${tier3}`, 'info');
            log(`  - Tier 4: ${tier4}`, 'info');
        };
        
        window.forceCullUpdate = function() {
            log('Forcing cull update...', 'info');
            
            const svg = d3.select('svg');
            if (svg.empty()) {
                log('No SVG found', 'error');
                return;
            }
            
            try {
                updateViewportCull(svg.node());
                ensureOceanStickyVisibility();
                log('✓ Forced cull update completed', 'success');
            } catch (error) {
                log(`✗ Error in forced cull update: ${error.message}`, 'error');
            }
        };
        
        // Auto-test on load
        window.addEventListener('load', () => {
            log('Verification page loaded', 'info');
            log('Load the main application and use the controls to test culling', 'info');
        });
        
        // Expose functions globally for testing
        window.updateViewportCull = updateViewportCull;
        window.ensureOceanStickyVisibility = ensureOceanStickyVisibility;
        window.currentTier = currentTier;
        window.tierForZoom = tierForZoom;
    </script>
    
    <!-- Load D3 v5 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
</body>
</html>
